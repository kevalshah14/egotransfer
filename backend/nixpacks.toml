# Nixpacks configuration for Railway
# See: https://nixpacks.com/docs/configuration/file
# Updated: 2025-11-17 - OpenGL dependencies fix

[phases.setup]
# System dependencies for OpenCV/MediaPipe in headless environment (Ubuntu 24.04 compatible)
aptPkgs = [
    "libgl1",               # OpenGL library (provides libGL.so.1)
    "libglx0",              # GLX library
    "libglib2.0-0",         # GLib library
    "libsm6",               # X11 Session Management library
    "libxext6",             # X11 extensions library
    "libxrender1",          # X Rendering Extension library
    "libgomp1",             # GCC OpenMP library
    "libgthread-2.0-0",     # GLib thread library
    "libice6",              # X11 Inter-Client Exchange library
    "libx11-6",             # X11 client library
    "libfontconfig1",       # Font configuration library
    "libxcb1",              # X protocol C-language Binding
    "ffmpeg"                # Video codec support
]

# Custom install phase to ensure ONLY opencv-python-headless is installed
[phases.install]
cmds = [
    "python -m venv --copies /opt/venv",
    ". /opt/venv/bin/activate && pip install --upgrade pip",
    ". /opt/venv/bin/activate && pip install 'numpy==1.26.4'",
    ". /opt/venv/bin/activate && pip install opencv-python-headless==4.8.1.78",
    ". /opt/venv/bin/activate && pip install -r requirements.txt",
    ". /opt/venv/bin/activate && (pip uninstall -y opencv-python opencv-contrib-python || true)",
    ". /opt/venv/bin/activate && pip install --force-reinstall opencv-python-headless==4.8.1.78",
    ". /opt/venv/bin/activate && pip install --force-reinstall 'numpy==1.26.4'",
    ". /opt/venv/bin/activate && pip list | grep -E 'opencv|numpy'"
]

[start]
cmd = "uvicorn main:app --host 0.0.0.0 --port $PORT"

